<!DOCTYPE html>
<html>
<head>
  <title>Mapa 1</title>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
  <link rel="stylesheet" type="text/css" href="css/styles.css" />
  <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet" type="text/css"/>
  

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
  <script src="http://popcornjs.org/code/dist/popcorn-complete.min.js"></script>
  <script src="leaflet.bouncemarker-master/bouncemarker.js" type="text/javascript"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script src="aishek-jquery-animateNumber-5f436e7/jquery.animateNumber.min.js"></script>

  <script src="javascript/refugis.js" type="text/javascript"></script>
  <script src="javascript/bombesMultiTotes.js" type="text/javascript"></script>
  <script src="javascript/bombesMulti.js" type="text/javascript"></script>
  <script>

    $(document).ready(
      function () {

      


      window.map = L.map('map', {
          attributionControl:false,
          zoomControl: false
        }).setView([41.386837, 2.169708], 14);//Per possar la orientacio inicial


      // Disable drag and zoom handlers.
      map.dragging.disable();
      map.touchZoom.disable();
      map.doubleClickZoom.disable();
      map.scrollWheelZoom.disable();
      map.keyboard.disable();

      // Disable tap handler, if present.
      if (map.tap) map.tap.disable();
      var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      });

      var martorell =L.tileLayer('http://www.300000kms.net/_btv/martorell/{z}/{x}/{y}.png', {
        maxZoom: 18,
        minZoom:12,
        tms: false,
        attribution: '<a target="_blank" href="http://www.300000kms.net">300.000Km/s</a>'
      });//carrega de papa
      var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });
      var baseMaps = {
        "Antic": martorell,
        "Actual Mapa": OpenStreetMap_BlackAndWhite,
        "Actual Satel·lit": Esri_WorldImagery
      };
      
      L.control.scale().addTo(map);
      

    //A���adimos las capas de OpenStreetMap y Google al mapa

      map.addLayer(martorell, Esri_WorldImagery);
       //Crar icona a partir d'una foto
      window.bombIcon = L.icon({
        iconUrl: 'img/bomb.png',
        iconSize: [20, 30],
        iconAnchor: [20, 30],
        popupAnchor: [0, -28]
      });
      window.expIcon = L.icon({
        iconUrl: 'img/explosion.png',
        iconSize: [20, 30],
        iconAnchor: [20, 30],
        popupAnchor: [0, -28]
      });
        

      function onEachFeature(feature, layer) {
        var popupContent = "<p>I started out as a GeoJSON " +
            feature.geometry.type + ", but now I'm a Leaflet vector!</p>";

        if (feature.properties && feature.properties.popupContent) {
          popupContent += feature.properties.popupContent;
        }

        layer.bindPopup(popupContent);
      }
      window.assetLayerGroup = L.layerGroup().addTo(map);

      var coorsLayer = L.geoJson(refugi, {

        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {icon: expIcon});
        },

        onEachFeature: onEachFeature
      });//.addTo(assetLayerGroup);
      var refugiLay = L.layerGroup();
      var refuguis = L.geoJson(refugi, {

        style: function (feature) {
          return feature.properties && feature.properties.style;
        },

        onEachFeature: onEachFeature,

        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, {
            radius: 5,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          });
        }
      }).addTo(refugiLay);

      var overlayMaps = {
        "Refuguis": refugiLay
      };
      L.control.layers(baseMaps, overlayMaps).addTo(map);
      
    
     


  });
      window.totalMorts=0;
      function onEachFeature(feature, layer) {
        mortsActuals =feature.properties.morts;
        dataActual = feature.properties.data;
        totalMorts =feature.properties.morts_totals;
        if (feature.properties && feature.properties.popupContent) {
          popupContent += feature.properties.popupContent;
        }

       //layer.bindPopup(popupContent);
      }
      function onEachFeatureBomb(feature, layer) {
        var popupContent = "<p>Data: " +feature.properties.data + " <br>Morts: "+feature.properties.morts+"</p>";
        if (feature.properties && feature.properties.popupContent) {
          popupContent += feature.properties.popupContent;
        }

       layer.bindPopup(popupContent);
      }
      
      function imprimir(diaBomb, lat, lon, zoom){
        assetLayerGroup.clearLayers();
        map.setView([lat,lon], zoom);
        //dadesAqui=JSON.parse(diaBomb);
        window.mortsActuals;
        window.dataActual;
        setTimeout(function() {

          
          
          
          
          var coorsLayer = L.geoJson(diaBomb, {

            pointToLayer: function (feature, latlng) {
              var markerBombs= L.marker(latlng, {
                icon: bombIcon,
                bounceOnAdd: true,
                bounceOnAddOptions: {duration: 1600, height: 200}
                

              });
              return markerBombs;
            },
            onEachFeature: onEachFeature

          }).addTo(assetLayerGroup);

          document.getElementById("dataAct").innerHTML = dataActual;
          //document.getElementById("morts").innerHTML = mortsActuals;
          //if(mortsActuals === "sense pre")
          //totalMorts= Number(totalMorts) + Number(mortsActuals);
          //document.getElementById("numTotal").innerHTML =totalMorts;

          document.getElementById("morts").innerHTML = 0;
          $('#morts').animateNumber({ number: mortsActuals });
          setTimeout(function() {
            coorsLayer
            assetLayerGroup.clearLayers();
            var coorsLayerExp = L.geoJson(diaBomb, {

            pointToLayer: function (feature, latlng) {
              var markerBombs= L.marker(latlng, {
                icon: expIcon
                

              });
              return markerBombs;
            },
            onEachFeature: onEachFeature

          }).addTo(assetLayerGroup);
            assetLayerGroup.removeLayer(coorsLayer);
            
            $('#total_morts').animateNumber({ number: totalMorts });
          }, 1600);
        }, 1500);
        

      }
      
      function simplificat(popTime, startTime, endTime, diaBomb, lat, lon, zoom){
        popTime.code({
            start: startTime,
            end: endTime,
            onStart: function() {

              var pos=(startTime - iniciFixe)/tempsEntre + 1;
              $( "#slider" ).slider( "value", pos );
              imprimir(diaBomb, lat,lon, zoom);
              
            }
          });

      }
      function iniciVideo(popTime, endTime){
        popTime.code({
            start: 0,
            end: endTime,
            onStart: function() {

              $( "#slider" ).slider( "value", 0 );
              assetLayerGroup.clearLayers();
              map.setView([41.386837, 2.169708], 14);
            }
          });

      }
      function finalVideo(popTime, startTime, endTime){
        popTime.code({
            start: startTime,
            end: endTime,
            onStart: function() {

              $( "#slider" ).slider( "value", 21 );
              assetLayerGroup.clearLayers();
              
              assetLayerGroup.clearLayers();
              var coorsLayerExp = L.geoJson(bombes, {

              pointToLayer: function (feature, latlng) {
                var markerBombs= L.marker(latlng, {
                  icon: expIcon
                  

                });
                return markerBombs;
              },
              onEachFeature: onEachFeatureBomb

            }).addTo(assetLayerGroup);
            map.setView([41.386837, 2.169708], 14);

            }
          });

      }

      // ensure the web page (DOM) has loaded
      document.addEventListener("DOMContentLoaded", function () {
           // Create a popcorn instance by calling the Youtube player plugin
        var videoPop = Popcorn( "#ourvideo" );
        $( "#slider" ).slider({
          max:20,
          min: 0,
          stop: function( event, ui ) {
            var calcul=iniciFixe+ (ui.value - 1) * tempsEntre;
            videoPop.currentTime(calcul);

          }

        });
        videoPop.pause();
        window.butPause= true;
        document.getElementById("ButtonPlay").innerHTML = "";

        //videoPop.play();
        window.iniciFixe= 9.8;
        var inici= iniciFixe;
        window.tempsEntre=7;
        var final=inici + tempsEntre -0.5;
        iniciVideo(videoPop, iniciFixe- 0.1);
        //TODO INICIAL POPUP
        simplificat(videoPop,inici, final, dia1937213, 41.401282, 2.179085);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1937529, 41.381260, 2.182768, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1937101, 41.384122, 2.194089, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia193811, 41.382750, 2.181187, 15);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938125, 41.374999, 2.169065, 15);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938130, 41.386049, 2.184796, 16);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia193835, 41.386077, 2.191147, 15);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        //17-3-1938
        simplificat(videoPop,inici, final, dia1938317A,  41.382615, 2.171243, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938317B,  41.382615, 2.171243, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938318,  41.382615, 2.171243, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia193864, 41.362932, 2.208380, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938719, 41.387446, 2.206292, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938819,  41.387446, 2.206292, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938924,  41.364195, 2.189822, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1938104,  41.364195, 2.189822, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia19381021,  41.382430, 2.185886, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia19381231,  41.382615, 2.171243, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1939121,   41.364195, 2.189822, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        simplificat(videoPop,inici, final, dia1939124,  41.386167, 2.194698, 14);
        inici=inici + tempsEntre;
        final= inici + tempsEntre -0.1;
        finalVideo(videoPop,inici, final);
        //TODO FINAL POPCORN
        window.videoProperties =videoPop;
        


        
      }, false);
      function funcButPlay(){
        if(butPause){
          videoProperties.play();
          butPause= false;
          //document.getElementById("ButtonPlay").innerHTML = "";
          document.getElementById("ButtonPlay").style.backgroundPosition = "-22px -7px";
        }else{
          videoProperties.pause();
          butPause= true;
          //document.getElementById("ButtonPlay").innerHTML = "";
          document.getElementById("ButtonPlay").style.backgroundPosition = "0px -7px";
        }
      }


var w = window.innerWidth;
console.log(w);

function expandMenu(){
  document.getElementById("menu").style.display = "block";
  document.getElementById("expand_bar").style.display = "none";
}

function hideMenu(){
    document.getElementById("menu").style.display = "none";
    document.getElementById("expand_bar").style.display = "block";
}

function responsive(){

  if (w <1024){
    document.getElementById("menu").style.display = "none";
    document.getElementById("expand_bar").style.display = "block";
  }else{
    document.getElementById("menu").style.display = "block";
    document.getElementById("expand_bar").style.display = "none";

  }

}





    </script>

</head>
<body class="webdoc" onload= "responsive()">
  <div id="expand_bar">
  <h1 class="title">Bombardeigs <strong>BCN 1937/39</strong></h1>
  <div class="expand_button" onclick="expandMenu()"></div>
  </div>
  <aside  id="menu">
  <div class="menu-container">
  <div onclick="hideMenu()"><h1 class="title">Bombardeigs <strong>BCN 1937/39</strong></h1></font>
   </div>
   <div><h2 class="data" id="dataAct">19 de Gener de 1936</h2><h2 class="morts_dia">(<span id="morts">0 </span>)</h2></div>
   <hr class="line"></hr>

  <div  class="counter"><span id="total_morts">0 </span> victimes</div>
  <hr class="line"></hr>
  <div style="text-align:center">
  <video height="270" width="auto" id="ourvideo" >
        <source src="bombesTmp.mp4" type="video/mp4">
  </video>
  </div>
   <hr class="line"></hr>

</div> 
 </aside>
  <div class="timeline-container">
  <aside id="timeline">
   <a onclick="funcButPlay()" id="ButtonPlay"></a> 
  <div id="slider" ></div>
   </aside>
 </div>
  <div style="position: relative;" id="map"></div>



</body>
    
</html>

